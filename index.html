<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Professional oscilloscope simulator with dual channels, variable precision measurements, and multiple trigger modes. Free educational tool for learning signal analysis.">
    <meta name="keywords" content="oscilloscope, simulator, signal analysis, waveform, electronics, education, measurement tool">
    <meta name="author" content="Oscilloscope Simulator">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://electronic-oscillator-simulator.netlify.app/">
    <meta property="og:title" content="Professional Oscilloscope Simulator">
    <meta property="og:description" content="Free web-based oscilloscope simulator for education and signal analysis">
    <meta property="og:image" content="https://electronic-oscillator-simulator.netlify.app/og-image.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://electronic-oscillator-simulator.netlify.app/">
    <meta property="twitter:title" content="Professional Oscilloscope Simulator">
    <meta property="twitter:description" content="Free web-based oscilloscope simulator for education and signal analysis">
    <meta property="twitter:image" content="https://electronic-oscillator-simulator.netlify.app/og-image.png">
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://pagead2.googlesyndication.com https://*.google.com https://*.googletagmanager.com;
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: https: http:;
        font-src 'self' data:;
        connect-src 'self' https://*.google.com https://*.doubleclick.net;
        frame-src https://googleads.g.doubleclick.net https://tpc.googlesyndication.com;
        object-src 'none';
        base-uri 'self';
        form-action 'self';
        frame-ancestors 'none';
        upgrade-insecure-requests;
    ">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- Permissions Policy -->
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
    
    <title>Professional Oscilloscope Simulator - Free Signal Analysis Tool</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üî¨</text></svg>">
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3532651292271019"
     crossorigin="anonymous"></script>
    
    <!-- Preconnect to improve performance -->
    <link rel="preconnect" href="https://pagead2.googlesyndication.com">
    <link rel="dns-prefetch" href="https://pagead2.googlesyndication.com">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #2a2a2a;
            min-height: 100vh;
            padding: 20px;
            color: #333;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Prevent text selection on controls */
        .btn, .wave-btn, .preset-btn, .step-btn {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .oscilloscope {
            max-width: 1600px;
            margin: 0 auto;
            background: linear-gradient(145deg, #c8c8c8, #e0e0e0);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #888;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .brand-name {
            font-size: 1.8em;
            font-weight: bold;
            color: #222;
        }

        .model-info {
            font-size: 0.9em;
            color: #555;
        }

        .power-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .power-led {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #333;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
            transition: all 0.3s;
        }

        .power-led.on {
            background: #ff3333;
            box-shadow: 0 0 20px #ff3333, inset 0 2px 5px rgba(0,0,0,0.3);
        }

        .trigger-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 5px;
        }

        .trigger-led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
            transition: all 0.3s;
        }

        .trigger-led.auto {
            background: #2196F3;
            box-shadow: 0 0 10px #2196F3;
        }

        .trigger-led.normal {
            background: #9E9E9E;
        }

        .trigger-led.armed {
            background: #ff9800;
            box-shadow: 0 0 10px #ff9800;
            animation: pulse 1s infinite;
        }

        .trigger-led.triggered {
            background: #4CAF50;
            box-shadow: 0 0 10px #4CAF50;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .trigger-text {
            font-size: 0.85em;
            font-weight: bold;
            color: #333;
        }

        .precision-selector {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .precision-label {
            font-size: 0.8em;
            font-weight: bold;
            color: #333;
        }

        .precision-btn {
            padding: 6px 12px;
            border: 2px solid #999;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.75em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .precision-btn:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
        }

        .precision-btn:active {
            transform: translateY(0);
        }

        .precision-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #45a049;
        }

        .display-container {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: inset 0 4px 20px rgba(0, 0, 0, 0.9);
        }

        .screen-bezel {
            background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
            padding: 25px;
            border-radius: 8px;
            position: relative;
        }

        #screen {
            display: block;
            width: 100%;
            background: #001a1a;
            border-radius: 5px;
            cursor: crosshair;
            touch-action: none;
        }

        .trigger-indicator {
            position: absolute;
            top: 35px;
            right: 35px;
            padding: 8px 15px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.9em;
            display: none;
            animation: fadeOut 0.5s ease-in-out;
            pointer-events: none;
        }

        .trigger-indicator.show {
            display: block;
        }

        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }

        .measurements-panel {
            margin-top: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .measurements-section {
            padding: 15px;
            background: rgba(0, 50, 50, 0.5);
            border-radius: 8px;
            border: 2px solid #004d4d;
        }

        .section-title {
            color: #00ff99;
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            border-bottom: 1px solid #00ff99;
            padding-bottom: 5px;
        }

        .measurements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
        }

        .measurement-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 5px;
            border-left: 3px solid;
        }

        .measurement-item.ch1 { border-color: #00ffff; }
        .measurement-item.ch2 { border-color: #ffff00; }
        .measurement-item.cursor { border-color: #ff00ff; }
        .measurement-item.time { border-color: #ff6600; }

        .meas-label {
            font-size: 0.7em;
            color: #66ff99;
            margin-bottom: 3px;
            text-transform: uppercase;
        }

        .meas-value {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.95em;
            color: #00ff66;
            font-weight: bold;
            word-break: break-word;
        }

        .controls-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-panel {
            background: linear-gradient(145deg, #e8e8e8, #f5f5f5);
            border-radius: 10px;
            padding: 20px;
            border: 3px solid;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .panel-ch1 { border-color: #00cccc; }
        .panel-ch2 { border-color: #cccc00; }
        .panel-timebase { border-color: #cc6600; }
        .panel-trigger { border-color: #0066cc; }
        .panel-cursors { border-color: #cc00cc; }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ccc;
        }

        .panel-title {
            font-weight: bold;
            font-size: 1.1em;
            text-transform: uppercase;
        }

        .ch1-color { color: #00cccc; }
        .ch2-color { color: #999900; }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: #999;
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
            border: 2px solid #666;
        }

        .toggle-switch.active {
            background: #4CAF50;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.85em;
        }

        .control-value {
            font-family: 'Courier New', Courier, monospace;
            color: #000;
            font-weight: bold;
            background: #fff;
            padding: 2px 8px;
            border-radius: 3px;
            border: 1px solid #999;
        }

        input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 4px;
            background: #999;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #333;
            cursor: pointer;
            border: 2px solid #666;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #333;
            cursor: pointer;
            border: 2px solid #666;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .input-with-buttons {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .step-btn {
            padding: 8px 12px;
            border: 2px solid #999;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.2s;
            min-width: 35px;
        }

        .step-btn:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
        }

        .step-btn:active {
            background: #d0d0d0;
            transform: translateY(0);
        }

        input[type="number"] {
            flex: 1;
            padding: 8px;
            border: 2px solid #999;
            border-radius: 5px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            min-width: 0;
        }

        /* Remove spinner buttons on number inputs */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        .unit-selector {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .unit-btn {
            flex: 1;
            padding: 5px;
            border: 2px solid #999;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .unit-btn:hover {
            background: #e0e0e0;
        }

        .unit-btn.active {
            background: #2196F3;
            color: white;
            border-color: #1976D2;
        }

        select {
            width: 100%;
            padding: 8px;
            border: 2px solid #999;
            border-radius: 5px;
            font-size: 0.9em;
            background: white;
            cursor: pointer;
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .wave-btn {
            padding: 10px;
            border: 2px solid #999;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .wave-btn:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
        }

        .wave-btn:active {
            transform: translateY(0);
        }

        .wave-btn.active {
            background: #333;
            color: white;
            border-color: #000;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            padding: 20px;
            background: linear-gradient(145deg, #e8e8e8, #f5f5f5);
            border-radius: 10px;
            border: 3px solid #888;
            margin-bottom: 20px;
        }

        .btn {
            padding: 15px 35px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-power {
            background: linear-gradient(145deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-stop {
            background: linear-gradient(145deg, #f44336, #da190b);
            color: white;
        }

        .btn-run {
            background: linear-gradient(145deg, #2196F3, #0b7dda);
            color: white;
        }

        .btn-single {
            background: linear-gradient(145deg, #FF9800, #F57C00);
            color: white;
        }

        .btn-single.armed {
            animation: btnPulse 1s infinite;
        }

        @keyframes btnPulse {
            0%, 100% { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }
            50% { box-shadow: 0 4px 20px rgba(255, 152, 0, 0.8); }
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .info-panel {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #2196F3;
            margin-bottom: 20px;
        }

        .info-panel h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: white;
            border-radius: 5px;
            font-size: 0.85em;
        }

        .shortcut-key {
            background: #333;
            color: white;
            padding: 3px 10px;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            font-size: 0.9em;
        }

        .step-indicator {
            font-size: 0.7em;
            color: #666;
            margin-top: 3px;
            font-style: italic;
        }

        .quick-preset {
            display: flex;
            gap: 5px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .preset-btn {
            flex: 1;
            min-width: 60px;
            padding: 5px;
            border: 2px solid #999;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
        }

        .preset-btn:active {
            transform: translateY(0);
        }

        .footer {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 0.85em;
            border-top: 2px solid #999;
            margin-top: 20px;
        }

        .footer a {
            color: #2196F3;
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer a:hover {
            text-decoration: underline;
            color: #0b7dda;
        }

        /* Cookie Consent Banner Styles */
        #cookieConsent {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            color: #fff;
            padding: 20px;
            text-align: center;
            z-index: 10000;
            display: none;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }

        #cookieConsent .consent-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        #cookieConsent p {
            margin: 0 0 15px 0;
            font-size: 1em;
            line-height: 1.6;
        }

        #cookieConsent a {
            color: #4CAF50;
            text-decoration: underline;
        }

        .consent-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .consent-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
        }

        .consent-btn-accept {
            background: #4CAF50;
            color: white;
        }

        .consent-btn-accept:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .consent-btn-reject {
            background: #f44336;
            color: white;
        }

        .consent-btn-reject:hover {
            background: #da190b;
            transform: translateY(-2px);
        }

        .consent-btn-manage {
            background: #2196F3;
            color: white;
            text-decoration: none;
            display: inline-block;
        }

        .consent-btn-manage:hover {
            background: #0b7dda;
            transform: translateY(-2px);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .oscilloscope {
                padding: 15px;
            }

            .brand-name {
                font-size: 1.3em;
            }

            .measurements-panel {
                grid-template-columns: 1fr;
            }

            .controls-layout {
                grid-template-columns: 1fr;
            }

            .precision-selector {
                justify-content: center;
            }

            .action-buttons {
                padding: 15px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 0.9em;
            }
        }

        /* Accessibility */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            margin: -1px;
            padding: 0;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* Focus styles for accessibility */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 3px solid #2196F3;
            outline-offset: 2px;
        }

        /* Loading state */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Print styles */
        @media print {
            body {
                background: white;
            }
            
            .action-buttons,
            .controls-layout,
            .footer,
            #cookieConsent {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="oscilloscope">
        <div class="header">
            <div class="brand">
                <div>
                    <h1 class="brand-name">üî¨ PRECISION OSCILLOSCOPE</h1>
                    <p class="model-info">Dual Channel ‚Ä¢ Variable Precision ‚Ä¢ 1GSa/s ‚Ä¢ 12-bit ADC</p>
                </div>
            </div>
            <div style="display: flex; gap: 20px; align-items: center;">
                <div class="trigger-status" role="status" aria-live="polite">
                    <div class="trigger-led" id="triggerLed" aria-hidden="true"></div>
                    <div class="trigger-text" id="triggerStatus">OFF</div>
                </div>
                <div class="power-indicator">
                    <span style="font-weight: bold;">POWER</span>
                    <div class="power-led" id="powerLed" role="status" aria-label="Power indicator"></div>
                </div>
            </div>
        </div>

        <!-- Global Precision Selector -->
        <div class="precision-selector" role="group" aria-label="Precision mode selection">
            <span class="precision-label">GLOBAL PRECISION MODE:</span>
            <button class="precision-btn" data-mode="coarse" aria-label="Coarse precision mode">COARSE (Fast)</button>
            <button class="precision-btn active" data-mode="normal" aria-label="Normal precision mode" aria-pressed="true">NORMAL</button>
            <button class="precision-btn" data-mode="fine" aria-label="Fine precision mode">FINE</button>
            <button class="precision-btn" data-mode="ultra" aria-label="Ultra-fine precision mode">ULTRA-FINE (¬µV/ns)</button>
        </div>

        <div class="display-container">
            <div class="screen-bezel">
                <canvas id="screen" width="1400" height="700" role="img" aria-label="Oscilloscope display showing waveforms"></canvas>
                <div class="trigger-indicator" id="triggerIndicator" role="alert" aria-live="assertive">‚ö° TRIG'D</div>
            </div>
            
            <div class="measurements-panel">
                <section class="measurements-section" aria-labelledby="ch1-measurements-title">
                    <h2 class="section-title" id="ch1-measurements-title">üìä Channel 1 Measurements</h2>
                    <div class="measurements-grid">
                        <div class="measurement-item ch1">
                            <div class="meas-label">Frequency</div>
                            <div class="meas-value" id="ch1Freq" aria-label="Channel 1 frequency">--- Hz</div>
                        </div>
                        <div class="measurement-item ch1">
                            <div class="meas-label">Period</div>
                            <div class="meas-value" id="ch1Period" aria-label="Channel 1 period">--- s</div>
                        </div>
                        <div class="measurement-item ch1">
                            <div class="meas-label">Peak-Peak</div>
                            <div class="meas-value" id="ch1Vpp" aria-label="Channel 1 peak-to-peak voltage">--- V</div>
                        </div>
                        <div class="measurement-item ch1">
                            <div class="meas-label">Amplitude</div>
                            <div class="meas-value" id="ch1Amp" aria-label="Channel 1 amplitude">--- V</div>
                        </div>
                        <div class="measurement-item ch1">
                            <div class="meas-label">RMS</div>
                            <div class="meas-value" id="ch1Rms" aria-label="Channel 1 RMS voltage">--- V</div>
                        </div>
                        <div class="measurement-item ch1">
                            <div class="meas-label">Mean</div>
                            <div class="meas-value" id="ch1Mean" aria-label="Channel 1 mean voltage">--- V</div>
                        </div>
                        <div class="measurement-item ch1">
                            <div class="meas-label">Max</div>
                            <div class="meas-value" id="ch1Max" aria-label="Channel 1 maximum voltage">--- V</div>
                        </div>
                        <div class="measurement-item ch1">
                            <div class="meas-label">Min</div>
                            <div class="meas-value" id="ch1Min" aria-label="Channel 1 minimum voltage">--- V</div>
                        </div>
                        <div class="measurement-item ch1">
                            <div class="meas-label">Rise Time</div>
                            <div class="meas-value" id="ch1Rise" aria-label="Channel 1 rise time">--- Œºs</div>
                        </div>
                        <div class="measurement-item ch1">
                            <div class="meas-label">Fall Time</div>
                            <div class="meas-value" id="ch1Fall" aria-label="Channel 1 fall time">--- Œºs</div>
                        </div>
                        <div class="measurement-item ch1">
                            <div class="meas-label">Duty Cycle</div>
                            <div class="meas-value" id="ch1Duty" aria-label="Channel 1 duty cycle">--- %</div>
                        </div>
                        <div class="measurement-item ch1">
                            <div class="meas-label">Overshoot</div>
                            <div class="meas-value" id="ch1Over" aria-label="Channel 1 overshoot">--- %</div>
                        </div>
                    </div>
                </section>

                <section class="measurements-section" aria-labelledby="ch2-measurements-title">
                    <h2 class="section-title" id="ch2-measurements-title">üìä Channel 2 Measurements</h2>
                    <div class="measurements-grid">
                        <div class="measurement-item ch2">
                            <div class="meas-label">Frequency</div>
                            <div class="meas-value" id="ch2Freq" aria-label="Channel 2 frequency">--- Hz</div>
                        </div>
                        <div class="measurement-item ch2">
                            <div class="meas-label">Period</div>
                            <div class="meas-value" id="ch2Period" aria-label="Channel 2 period">--- s</div>
                        </div>
                        <div class="measurement-item ch2">
                            <div class="meas-label">Peak-Peak</div>
                            <div class="meas-value" id="ch2Vpp" aria-label="Channel 2 peak-to-peak voltage">--- V</div>
                        </div>
                        <div class="measurement-item ch2">
                            <div class="meas-label">Amplitude</div>
                            <div class="meas-value" id="ch2Amp" aria-label="Channel 2 amplitude">--- V</div>
                        </div>
                        <div class="measurement-item ch2">
                            <div class="meas-label">RMS</div>
                            <div class="meas-value" id="ch2Rms" aria-label="Channel 2 RMS voltage">--- V</div>
                        </div>
                        <div class="measurement-item ch2">
                            <div class="meas-label">Mean</div>
                            <div class="meas-value" id="ch2Mean" aria-label="Channel 2 mean voltage">--- V</div>
                        </div>
                        <div class="measurement-item ch2">
                            <div class="meas-label">Max</div>
                            <div class="meas-value" id="ch2Max" aria-label="Channel 2 maximum voltage">--- V</div>
                        </div>
                        <div class="measurement-item ch2">
                            <div class="meas-label">Min</div>
                            <div class="meas-value" id="ch2Min" aria-label="Channel 2 minimum voltage">--- V</div>
                        </div>
                        <div class="measurement-item ch2">
                            <div class="meas-label">Rise Time</div>
                            <div class="meas-value" id="ch2Rise" aria-label="Channel 2 rise time">--- Œºs</div>
                        </div>
                        <div class="measurement-item ch2">
                            <div class="meas-label">Fall Time</div>
                            <div class="meas-value" id="ch2Fall" aria-label="Channel 2 fall time">--- Œºs</div>
                        </div>
                        <div class="measurement-item ch2">
                            <div class="meas-label">Duty Cycle</div>
                            <div class="meas-value" id="ch2Duty" aria-label="Channel 2 duty cycle">--- %</div>
                        </div>
                        <div class="measurement-item ch2">
                            <div class="meas-label">Overshoot</div>
                            <div class="meas-value" id="ch2Over" aria-label="Channel 2 overshoot">--- %</div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="measurements-panel">
                <section class="measurements-section" aria-labelledby="cursor-measurements-title">
                    <h2 class="section-title" id="cursor-measurements-title">üìê Cursor Measurements</h2>
                    <div class="measurements-grid">
                        <div class="measurement-item cursor">
                            <div class="meas-label">Cursor 1 Time</div>
                            <div class="meas-value" id="cursor1Time">--- s</div>
                        </div>
                        <div class="measurement-item cursor">
                            <div class="meas-label">Cursor 2 Time</div>
                            <div class="meas-value" id="cursor2Time">--- s</div>
                        </div>
                        <div class="measurement-item cursor">
                            <div class="meas-label">ŒîTime</div>
                            <div class="meas-value" id="deltaTime">--- s</div>
                        </div>
                        <div class="measurement-item cursor">
                            <div class="meas-label">1/ŒîT (Freq)</div>
                            <div class="meas-value" id="deltaFreq">--- Hz</div>
                        </div>
                        <div class="measurement-item cursor">
                            <div class="meas-label">Cursor 1 Voltage</div>
                            <div class="meas-value" id="cursor1Volt">--- V</div>
                        </div>
                        <div class="measurement-item cursor">
                            <div class="meas-label">Cursor 2 Voltage</div>
                            <div class="meas-value" id="cursor2Volt">--- V</div>
                        </div>
                        <div class="measurement-item cursor">
                            <div class="meas-label">ŒîVoltage</div>
                            <div class="meas-value" id="deltaVolt">--- V</div>
                        </div>
                        <div class="measurement-item cursor">
                            <div class="meas-label">Cursor Mode</div>
                            <div class="meas-value" id="cursorMode">OFF</div>
                        </div>
                    </div>
                </section>

                <section class="measurements-section" aria-labelledby="advanced-analysis-title">
                    <h2 class="section-title" id="advanced-analysis-title">üî¨ Advanced Analysis</h2>
                    <div class="measurements-grid">
                        <div class="measurement-item time">
                            <div class="meas-label">Phase Diff</div>
                            <div class="meas-value" id="phaseDiff">--- ¬∞</div>
                        </div>
                        <div class="measurement-item time">
                            <div class="meas-label">Time Delay</div>
                            <div class="meas-value" id="timeDelay">--- s</div>
                        </div>
                        <div class="measurement-item time">
                            <div class="meas-label">Sample Rate</div>
                            <div class="meas-value" id="sampleRate">10.00 kSa/s</div>
                        </div>
                        <div class="measurement-item time">
                            <div class="meas-label">Samples</div>
                            <div class="meas-value" id="numSamples">10000</div>
                        </div>
                        <div class="measurement-item time">
                            <div class="meas-label">CH1 Std Dev</div>
                            <div class="meas-value" id="ch1StdDev">--- V</div>
                        </div>
                        <div class="measurement-item time">
                            <div class="meas-label">CH2 Std Dev</div>
                            <div class="meas-value" id="ch2StdDev">--- V</div>
                        </div>
                        <div class="measurement-item time">
                            <div class="meas-label">CH1 Cycles</div>
                            <div class="meas-value" id="ch1Cycles">---</div>
                        </div>
                        <div class="measurement-item time">
                            <div class="meas-label">CH2 Cycles</div>
                            <div class="meas-value" id="ch2Cycles">---</div>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <div class="controls-layout">
            <!-- Channel 1 Controls -->
            <section class="control-panel panel-ch1" aria-labelledby="ch1-title">
                <div class="panel-header">
                    <h2 class="panel-title ch1-color" id="ch1-title">Channel 1</h2>
                    <button class="toggle-switch active" id="ch1Toggle" role="switch" aria-checked="true" aria-label="Toggle Channel 1">
                        <div class="toggle-slider"></div>
                    </button>
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <label for="ch1VoltsDiv">Volts/Div</label>
                        <span class="control-value" id="ch1VoltsDivDisplay" aria-live="polite">1.00 V</span>
                    </div>
                    <input type="range" id="ch1VoltsDiv" min="0" max="15" value="9" step="1" aria-label="Channel 1 volts per division">
                    <div class="quick-preset" role="group" aria-label="Channel 1 volt/div presets">
                        <button class="preset-btn" onclick="setVoltsDiv('ch1', 0.001)" aria-label="Set to 1 millivolt">1mV</button>
                        <button class="preset-btn" onclick="setVoltsDiv('ch1', 0.01)" aria-label="Set to 10 millivolts">10mV</button>
                        <button class="preset-btn" onclick="setVoltsDiv('ch1', 0.1)" aria-label="Set to 100 millivolts">100mV</button>
                        <button class="preset-btn" onclick="setVoltsDiv('ch1', 1)" aria-label="Set to 1 volt">1V</button>
                        <button class="preset-btn" onclick="setVoltsDiv('ch1', 10)" aria-label="Set to 10 volts">10V</button>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label"><span>Volts/Div (Precise)</span></label>
                    <div class="input-with-buttons">
                        <button class="step-btn" onclick="adjustVoltsDiv('ch1', -1)" aria-label="Decrease Channel 1 volts/div">‚àí</button>
                        <input type="number" id="ch1VoltsDivInput" value="1.000" step="0.001" aria-label="Channel 1 volts/div precise value">
                        <button class="step-btn" onclick="adjustVoltsDiv('ch1', 1)" aria-label="Increase Channel 1 volts/div">+</button>
                    </div>
                    <div class="step-indicator" id="ch1VoltsDivStep" role="status" aria-live="polite">Step: 0.001 V</div>
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <label for="ch1Position">Vertical Position</label>
                        <span class="control-value" id="ch1PosDisplay" aria-live="polite">0</span>
                    </div>
                    <input type="range" id="ch1Position" min="-100" max="100" value="0" step="1" aria-label="Channel 1 vertical position">
                </div>

                <div class="control-group">
                    <label class="control-label"><span>Frequency</span></label>
                    <div class="input-with-buttons">
                        <button class="step-btn" onclick="adjustFreq('ch1', -1)" aria-label="Decrease Channel 1 frequency">‚àí</button>
                        <input type="number" id="ch1SignalFreq" value="1000" step="1" aria-label="Channel 1 signal frequency">
                        <button class="step-btn" onclick="adjustFreq('ch1', 1)" aria-label="Increase Channel 1 frequency">+</button>
                    </div>
                    <div class="unit-selector" role="group" aria-label="Channel 1 frequency units">
                        <button class="unit-btn" onclick="setFreqUnit('ch1', 1)" aria-label="Hertz">Hz</button>
                        <button class="unit-btn active" onclick="setFreqUnit('ch1', 1000)" aria-pressed="true" aria-label="Kilohertz">kHz</button>
                        <button class="unit-btn" onclick="setFreqUnit('ch1', 1000000)" aria-label="Megahertz">MHz</button>
                    </div>
                    <div class="step-indicator" id="ch1FreqStep" role="status" aria-live="polite">Step: 1 Hz</div>
                </div>

                <div class="control-group">
                    <label class="control-label"><span>Amplitude</span></label>
                    <div class="input-with-buttons">
                        <button class="step-btn" onclick="adjustAmp('ch1', -1)" aria-label="Decrease Channel 1 amplitude">‚àí</button>
                        <input type="number" id="ch1SignalAmp" value="2.000" step="0.001" aria-label="Channel 1 signal amplitude">
                        <button class="step-btn" onclick="adjustAmp('ch1', 1)" aria-label="Increase Channel 1 amplitude">+</button>
                    </div>
                    <div class="unit-selector" role="group" aria-label="Channel 1 amplitude units">
                        <button class="unit-btn" onclick="setAmpUnit('ch1', 0.001)" aria-label="Millivolts">mV</button>
                        <button class="unit-btn active" onclick="setAmpUnit('ch1', 1)" aria-pressed="true" aria-label="Volts">V</button>
                    </div>
                    <div class="step-indicator" id="ch1AmpStep" role="status" aria-live="polite">Step: 0.001 V</div>
                </div>

                <div class="control-group">
                    <label class="control-label"><span>Offset</span></label>
                    <div class="input-with-buttons">
                        <button class="step-btn" onclick="adjustOffset('ch1', -1)" aria-label="Decrease Channel 1 offset">‚àí</button>
                        <input type="number" id="ch1Offset" value="0.000" step="0.001" aria-label="Channel 1 signal offset">
                        <button class="step-btn" onclick="adjustOffset('ch1', 1)" aria-label="Increase Channel 1 offset">+</button>
                    </div>
                    <div class="step-indicator" id="ch1OffsetStep" role="status" aria-live="polite">Step: 0.001 V</div>
                </div>

                <div class="control-group">
                    <label class="control-label"><span>Phase</span></label>
                    <div class="input-with-buttons">
                        <button class="step-btn" onclick="adjustPhase('ch1', -1)" aria-label="Decrease Channel 1 phase">‚àí</button>
                        <input type="number" id="ch1Phase" value="0" step="0.1" aria-label="Channel 1 signal phase">
                        <button class="step-btn" onclick="adjustPhase('ch1', 1)" aria-label="Increase Channel 1 phase">+</button>
                    </div>
                    <div class="step-indicator" id="ch1PhaseStep" role="status" aria-live="polite">Step: 0.1 ¬∞</div>
                </div>

                <div class="control-group">
                    <label class="control-label"><span>Test Signal</span></label>
                    <div class="button-group" role="group" aria-label="Channel 1 waveform selection">
                        <button class="wave-btn active" data-ch="1" data-wave="sine" aria-pressed="true">SINE</button>
                        <button class="wave-btn" data-ch="1" data-wave="square">SQUARE</button>
                        <button class="wave-btn" data-ch="1" data-wave="triangle">TRIANGLE</button>
                        <button class="wave-btn" data-ch="1" data-wave="sawtooth">SAWTOOTH</button>
                    </div>
                </div>
            </section>

            <!-- Channel 2 Controls -->
            <section class="control-panel panel-ch2" aria-labelledby="ch2-title">
                <div class="panel-header">
                    <h2 class="panel-title ch2-color" id="ch2-title">Channel 2</h2>
                    <button class="toggle-switch active" id="ch2Toggle" role="switch" aria-checked="true" aria-label="Toggle Channel 2">
                        <div class="toggle-slider"></div>
                    </button>
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <label for="ch2VoltsDiv">Volts/Div</label>
                        <span class="control-value" id="ch2VoltsDivDisplay" aria-live="polite">1.00 V</span>
                    </div>
                    <input type="range" id="ch2VoltsDiv" min="0" max="15" value="9" step="1" aria-label="Channel 2 volts per division">
                    <div class="quick-preset" role="group" aria-label="Channel 2 volt/div presets">
                        <button class="preset-btn" onclick="setVoltsDiv('ch2', 0.001)" aria-label="Set to 1 millivolt">1mV</button>
                        <button class="preset-btn" onclick="setVoltsDiv('ch2', 0.01)" aria-label="Set to 10 millivolts">10mV</button>
                        <button class="preset-btn" onclick="setVoltsDiv('ch2', 0.1)" aria-label="Set to 100 millivolts">100mV</button>
                        <button class="preset-btn" onclick="setVoltsDiv('ch2', 1)" aria-label="Set to 1 volt">1V</button>
                        <button class="preset-btn" onclick="setVoltsDiv('ch2', 10)" aria-label="Set to 10 volts">10V</button>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label"><span>Volts/Div (Precise)</span></label>
                    <div class="input-with-buttons">
                        <button class="step-btn" onclick="adjustVoltsDiv('ch2', -1)" aria-label="Decrease Channel 2 volts/div">‚àí</button>
                        <input type="number" id="ch2VoltsDivInput" value="1.000" step="0.001" aria-label="Channel 2 volts/div precise value">
                        <button class="step-btn" onclick="adjustVoltsDiv('ch2', 1)" aria-label="Increase Channel 2 volts/div">+</button>
                    </div>
                    <div class="step-indicator" id="ch2VoltsDivStep" role="status" aria-live="polite">Step: 0.001 V</div>
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <label for="ch2Position">Vertical Position</label>
                        <span class="control-value" id="ch2PosDisplay" aria-live="polite">0</span>
                    </div>
                    <input type="range" id="ch2Position" min="-100" max="100" value="0" step="1" aria-label="Channel 2 vertical position">
                </div>

                <div class="control-group">
                    <label class="control-label"><span>Frequency</span></label>
                    <div class="input-with-buttons">
                        <button class="step-btn" onclick="adjustFreq('ch2', -1)" aria-label="Decrease Channel 2 frequency">‚àí</button>
                        <input type="number" id="ch2SignalFreq" value="500" step="1" aria-label="Channel 2 signal frequency">
                        <button class="step-btn" onclick="adjustFreq('ch2', 1)" aria-label="Increase Channel 2 frequency">+</button>
                    </div>
                    <div class="unit-selector" role="group" aria-label="Channel 2 frequency units">
                        <button class="unit-btn" onclick="setFreqUnit('ch2', 1)" aria-label="Hertz">Hz</button>
                        <button class="unit-btn active" onclick="setFreqUnit('ch2', 1000)" aria-pressed="true" aria-label="Kilohertz">kHz</button>
                        <button class="unit-btn" onclick="setFreqUnit('ch2', 1000000)" aria-label="Megahertz">MHz</button>
                    </div>
                    <div class="step-indicator" id="ch2FreqStep" role="status" aria-live="polite">Step: 1 Hz</div>
                </div>

                <div class="control-group">
                    <label class="control-label"><span>Amplitude</span></label>
                    <div class="input-with-buttons">
                        <button class="step-btn" onclick="adjustAmp('ch2', -1)" aria-label="Decrease Channel 2 amplitude">‚àí</button>
                        <input type="number" id="ch2SignalAmp" value="3.000" step="0.001" aria-label="Channel 2 signal amplitude">
                        <button class="step-btn" onclick="adjustAmp('ch2', 1)" aria-label="Increase Channel 2 amplitude">+</button>
                    </div>
                    <div class="unit-selector" role="group" aria-label="Channel 2 amplitude units">
                        <button class="unit-btn" onclick="setAmpUnit('ch2', 0.001)" aria-label="Millivolts">mV</button>
                        <button class="unit-btn active" onclick="setAmpUnit('ch2', 1)" aria-pressed="true" aria-label="Volts">V</button>
                    </div>
                    <div class="step-indicator" id="ch2AmpStep" role="status" aria-live="polite">Step: 0.001 V</div>
                </div>

                <div class="control-group">
                    <label class="control-label"><span>Offset</span></label>
                    <div class="input-with-buttons">
                        <button class="step-btn" onclick="adjustOffset('ch2', -1)" aria-label="Decrease Channel 2 offset">‚àí</button>
                        <input type="number" id="ch2Offset" value="0.000" step="0.001" aria-label="Channel 2 signal offset">
                        <button class="step-btn" onclick="adjustOffset('ch2', 1)" aria-label="Increase Channel 2 offset">+</button>
                    </div>
                    <div class="step-indicator" id="ch2OffsetStep" role="status" aria-live="polite">Step: 0.001 V</div>
                </div>

                <div class="control-group">
                    <label class="control-label"><span>Phase</span></label>
                    <div class="input-with-buttons">
                        <button class="step-btn" onclick="adjustPhase('ch2', -1)" aria-label="Decrease Channel 2 phase">‚àí</button>
                        <input type="number" id="ch2Phase" value="0" step="0.1" aria-label="Channel 2 signal phase">
                        <button class="step-btn" onclick="adjustPhase('ch2', 1)" aria-label="Increase Channel 2 phase">+</button>
                    </div>
                    <div class="step-indicator" id="ch2PhaseStep" role="status" aria-live="polite">Step: 0.1 ¬∞</div>
                </div>

                <div class="control-group">
                    <label class="control-label"><span>Test Signal</span></label>
                    <div class="button-group" role="group" aria-label="Channel 2 waveform selection">
                        <button class="wave-btn active" data-ch="2" data-wave="sine" aria-pressed="true">SINE</button>
                        <button class="wave-btn" data-ch="2" data-wave="square">SQUARE</button>
                        <button class="wave-btn" data-ch="2" data-wave="triangle">TRIANGLE</button>
                        <button class="wave-btn" data-ch="2" data-wave="sawtooth">SAWTOOTH</button>
                    </div>
                </div>
            </section>

            <!-- Timebase Controls -->
            <section class="control-panel panel-timebase" aria-labelledby="timebase-title">
                <div class="panel-header">
                    <h2 class="panel-title" id="timebase-title">Timebase</h2>
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <label for="timebaseDiv">Time/Div</label>
                        <span class="control-value" id="timebaseDivDisplay" aria-live="polite">200.000 Œºs</span>
                    </div>
                    <input type="range" id="timebaseDiv" min="0" max="14" value="7" step="1" aria-label="Time per division">
                    <div class="quick-preset" role="group" aria-label="Time/div presets">
                        <button class="preset-btn" onclick="setTimebase(0.000001)" aria-label="Set to 1 microsecond">1Œºs</button>
                        <button class="preset-btn" onclick="setTimebase(0.00001)" aria-label="Set to 10 microseconds">10Œºs</button>
                        <button class="preset-btn" onclick="setTimebase(0.001)" aria-label="Set to 1 millisecond">1ms</button>
                        <button class="preset-btn" onclick="setTimebase(0.01)" aria-label="Set to 10 milliseconds">10ms</button>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label"><span>Time/Div (precise)</span></label>
                    <div class="input-with-buttons">
                        <button class="step-btn" onclick="adjustTimebase(-1)" aria-label="Decrease time/div">‚àí</button>
                        <input type="number" id="timebaseInput" value="0.0002" step="0.000001" aria-label="Time/div precise value">
                        <button class="step-btn" onclick="adjustTimebase(1)" aria-label="Increase time/div">+</button>
                    </div>
                    <div class="unit-selector" role="group" aria-label="Time/div units">
                        <button class="unit-btn" onclick="setTimebaseUnit(0.000000001)" aria-label="Nanoseconds">ns</button>
                        <button class="unit-btn active" onclick="setTimebaseUnit(0.000001)" aria-pressed="true" aria-label="Microseconds">Œºs</button>
                        <button class="unit-btn" onclick="setTimebaseUnit(0.001)" aria-label="Milliseconds">ms</button>
                        <button class="unit-btn" onclick="setTimebaseUnit(1)" aria-label="Seconds">s</button>
                    </div>
                    <div class="step-indicator" id="timebaseStep" role="status" aria-live="polite">Step: 0.000001 s</div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="sampleRateSelect"><span>Sample Rate</span></label>
                    <select id="sampleRateSelect" aria-label="Sample rate selection">
                        <option value="1000">1 kSa/s</option>
                        <option value="10000" selected>10 kSa/s</option>
                        <option value="100000">100 kSa/s</option>
                        <option value="1000000">1 MSa/s</option>
                        <option value="10000000">10 MSa/s</option>
                    </select>
                </div>
            </section>

            <!-- Trigger Controls -->
            <section class="control-panel panel-trigger" aria-labelledby="trigger-title">
                <div class="panel-header">
                    <h2 class="panel-title" id="trigger-title">Trigger</h2>
                </div>

                <div class="control-group">
                    <label class="control-label" for="triggerModeSelect"><span>Mode</span></label>
                    <select id="triggerModeSelect" aria-label="Trigger mode selection">
                        <option value="auto">AUTO (Continuous)</option>
                        <option value="normal">NORMAL (Wait for Trigger)</option>
                        <option value="single">SINGLE (One-Shot)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label" for="triggerSource"><span>Source</span></label>
                    <select id="triggerSource" aria-label="Trigger source selection">
                        <option value="ch1">Channel 1</option>
                        <option value="ch2">Channel 2</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label" for="triggerSlope"><span>Slope</span></label>
                    <select id="triggerSlope" aria-label="Trigger slope selection">
                        <option value="rising">Rising Edge ‚Üó</option>
                        <option value="falling">Falling Edge ‚Üò</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label"><span>Trigger Level</span></label>
                    <div class="input-with-buttons">
                        <button class="step-btn" onclick="adjustTriggerLevel(-1)" aria-label="Decrease trigger level">‚àí</button>
                        <input type="number" id="triggerLevelInput" value="0.000" step="0.001" aria-label="Trigger level value">
                        <button class="step-btn" onclick="adjustTriggerLevel(1)" aria-label="Increase trigger level">+</button>
                    </div>
                    <div class="step-indicator" id="triggerLevelStep" role="status" aria-live="polite">Step: 0.001 V</div>
                </div>
            </section>

            <!-- Cursor Controls -->
            <section class="control-panel panel-cursors" aria-labelledby="cursors-title">
                <div class="panel-header">
                    <h2 class="panel-title" id="cursors-title">Cursors</h2>
                    <button class="toggle-switch" id="cursorsToggle" role="switch" aria-checked="false" aria-label="Toggle cursors">
                        <div class="toggle-slider"></div>
                    </button>
                </div>

                <div class="control-group">
                    <label class="control-label" for="cursorModeSelect"><span>Cursor Mode</span></label>
                    <select id="cursorModeSelect" aria-label="Cursor mode selection">
                        <option value="off">Off</option>
                        <option value="vertical">Vertical (Time)</option>
                        <option value="horizontal">Horizontal (Voltage)</option>
                        <option value="both">Both</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label"><span>Cursor 1 Position (%)</span></label>
                    <div class="input-with-buttons">
                        <button class="step-btn" onclick="adjustCursor(1, -1)" aria-label="Move cursor 1 left">‚àí</button>
                        <input type="number" id="cursor1Pos" value="25" min="0" max="100" step="0.1" aria-label="Cursor 1 position">
                        <button class="step-btn" onclick="adjustCursor(1, 1)" aria-label="Move cursor 1 right">+</button>
                    </div>
                    <div class="step-indicator" id="cursor1Step" role="status" aria-live="polite">Step: 0.1 %</div>
                </div>

                <div class="control-group">
                    <label class="control-label"><span>Cursor 2 Position (%)</span></label>
                    <div class="input-with-buttons">
                        <button class="step-btn" onclick="adjustCursor(2, -1)" aria-label="Move cursor 2 left">‚àí</button>
                        <input type="number" id="cursor2Pos" value="75" min="0" max="100" step="0.1" aria-label="Cursor 2 position">
                        <button class="step-btn" onclick="adjustCursor(2, 1)" aria-label="Move cursor 2 right">+</button>
                    </div>
                    <div class="step-indicator" id="cursor2Step" role="status" aria-live="polite">Step: 0.1 %</div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="cursorSource"><span>Cursor Source</span></label>
                    <select id="cursorSource" aria-label="Cursor source selection">
                        <option value="ch1">Channel 1</option>
                        <option value="ch2">Channel 2</option>
                    </select>
                </div>
            </section>
        </div>

        <div class="action-buttons" role="group" aria-label="Main controls">
            <button class="btn btn-power" id="powerBtn" aria-label="Power control">‚ö° POWER ON</button>
            <button class="btn btn-run" id="runBtn" disabled aria-label="Start continuous mode">‚ñ∂ RUN</button>
            <button class="btn btn-stop" id="stopBtn" disabled aria-label="Stop acquisition">‚è∏ STOP</button>
            <button class="btn btn-single" id="singleBtn" disabled aria-label="Single shot capture">üì∏ SINGLE</button>
        </div>

        <div class="info-panel">
            <h3>‚å®Ô∏è Keyboard Shortcuts & Trigger Modes</h3>
            <div style="margin-bottom: 15px; padding: 10px; background: #e7f3ff; border-radius: 5px;">
                <strong>Trigger Modes Explained:</strong><br>
                ‚Ä¢ <strong>AUTO:</strong> Continuous updates even without trigger (free-running)<br>
                ‚Ä¢ <strong>NORMAL:</strong> Only updates when trigger condition is met<br>
                ‚Ä¢ <strong>SINGLE:</strong> Arms trigger, captures one waveform, then stops
            </div>
            <div class="shortcuts-grid">
                <div class="shortcut-item">
                    <span>Power On/Off</span>
                    <kbd class="shortcut-key">P</kbd>
                </div>
                <div class="shortcut-item">
                    <span>Run/Stop</span>
                    <kbd class="shortcut-key">SPACE</kbd>
                </div>
                <div class="shortcut-item">
                    <span>Single Shot</span>
                    <kbd class="shortcut-key">S</kbd>
                </div>
                <div class="shortcut-item">
                    <span>Toggle CH1</span>
                    <kbd class="shortcut-key">1</kbd>
                </div>
                <div class="shortcut-item">
                    <span>Toggle CH2</span>
                    <kbd class="shortcut-key">2</kbd>
                </div>
                <div class="shortcut-item">
                    <span>Toggle Cursors</span>
                    <kbd class="shortcut-key">C</kbd>
                </div>
                <div class="shortcut-item">
                    <span>Time/Div + (Coarser)</span>
                    <kbd class="shortcut-key">‚Üí</kbd>
                </div>
                <div class="shortcut-item">
                    <span>Time/Div - (Finer)</span>
                    <kbd class="shortcut-key">‚Üê</kbd>
                </div>
                <div class="shortcut-item">
                    <span>CH1 Volts/Div +</span>
                    <kbd class="shortcut-key">‚Üë</kbd>
                </div>
                <div class="shortcut-item">
                    <span>CH1 Volts/Div -</span>
                    <kbd class="shortcut-key">‚Üì</kbd>
                </div>
                <div class="shortcut-item">
                    <span>Precision: Coarse</span>
                    <kbd class="shortcut-key">F1</kbd>
                </div>
                <div class="shortcut-item">
                    <span>Precision: Normal</span>
                    <kbd class="shortcut-key">F2</kbd>
                </div>
                <div class="shortcut-item">
                    <span>Precision: Fine</span>
                    <kbd class="shortcut-key">F3</kbd>
                </div>
                <div class="shortcut-item">
                    <span>Precision: Ultra</span>
                    <kbd class="shortcut-key">F4</kbd>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>¬© 2024 Precision Oscilloscope Simulator | 
            <a href="privacy-policy.html" rel="noopener noreferrer">Privacy Policy</a> | 
            <a href="terms-of-service.html" rel="noopener noreferrer">Terms of Service</a> |
            <a href="https://github.com/OxMalaeee/electronic-oscillator-simulator" target="_blank" rel="noopener noreferrer">GitHub</a></p>
        </footer>
    </div>

    <!-- Cookie Consent Banner -->
    <div id="cookieConsent" role="dialog" aria-labelledby="cookieConsentTitle" aria-describedby="cookieConsentDesc">
        <div class="consent-content">
            <h2 id="cookieConsentTitle" class="visually-hidden">Cookie Consent</h2>
            <p id="cookieConsentDesc">
                üç™ This website uses cookies and Google AdSense to display personalized advertisements and improve your experience. 
                By continuing to use this site, you consent to our use of cookies.
                <a href="privacy-policy.html" rel="noopener noreferrer">Learn more in our Privacy Policy</a>
            </p>
            <div class="consent-buttons">
                <button class="consent-btn consent-btn-accept" onclick="acceptCookies()" aria-label="Accept all cookies">
                    ‚úì Accept All Cookies
                </button>
                <button class="consent-btn consent-btn-reject" onclick="rejectCookies()" aria-label="Reject non-essential cookies">
                    ‚úó Reject Non-Essential
                </button>
                <a href="privacy-policy.html" class="consent-btn consent-btn-manage" rel="noopener noreferrer" aria-label="Manage cookie preferences">
                    ‚öô Manage Preferences
                </a>
            </div>
        </div>
    </div>

    <script>
        'use strict';
        
        // Security: Input validation and sanitization
        const SecurityUtils = {
            sanitizeNumber: function(value, min, max, defaultValue) {
                const num = parseFloat(value);
                if (isNaN(num) || !isFinite(num)) return defaultValue;
                return Math.max(min, Math.min(max, num));
            },
            
            clamp: function(value, min, max) {
                return Math.max(min, Math.min(max, value));
            },
            
            escapeHtml: function(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };
        
        // Error handling wrapper
        function safeExecute(fn, errorMsg) {
            try {
                return fn();
            } catch (error) {
                console.error(errorMsg || 'An error occurred:', error);
                return null;
            }
        }

        // Canvas setup
        const canvas = document.getElementById('screen');
        const ctx = canvas.getContext('2d', { alpha: false }); // Performance optimization
        
        // State
        let powerOn = false;
        let running = false;
        let triggerMode = 'auto';
        let animationId = null;
        let time = 0;
        let sampleRate = 10000;
        let capturedData = null;
        let waitingForTrigger = false;

        // Precision mode settings
        let precisionMode = 'normal';
        const precisionSteps = {
            coarse: {
                freq: 100,
                amp: 0.1,
                offset: 0.1,
                phase: 10,
                timebase: 0.001,
                cursor: 5,
                voltsDiv: 0.1,
                triggerLevel: 0.1
            },
            normal: {
                freq: 1,
                amp: 0.001,
                offset: 0.01,
                phase: 0.1,
                timebase: 0.0001,
                cursor: 0.1,
                voltsDiv: 0.001,
                triggerLevel: 0.001
            },
            fine: {
                freq: 0.01,
                amp: 0.0001,
                offset: 0.001,
                phase: 0.01,
                timebase: 0.000001,
                cursor: 0.01,
                voltsDiv: 0.0001,
                triggerLevel: 0.0001
            },
            ultra: {
                freq: 0.00001,
                amp: 0.000001,
                offset: 0.0001,
                phase: 0.001,
                timebase: 0.000000001,
                cursor: 0.001,
                voltsDiv: 0.000001,
                triggerLevel: 0.000001
            }
        };

        // Channels state with validation
        const channels = {
            ch1: {
                enabled: true,
                voltsDiv: 1,
                position: 0,
                waveform: 'sine',
                frequency: 1000,
                amplitude: 2,
                offset: 0,
                phase: 0,
                color: '#00ffff',
                data: []
            },
            ch2: {
                enabled: true,
                voltsDiv: 1,
                position: 0,
                waveform: 'sine',
                frequency: 500,
                amplitude: 3,
                offset: 0,
                phase: 0,
                color: '#ffff00',
                data: []
            }
        };

        // Timebase
        const timebaseValues = [0.000001, 0.000002, 0.000005, 0.00001, 0.00002, 0.00005, 0.0001, 0.0002, 0.0005, 0.001, 0.002, 0.005, 0.01, 0.02, 0.05];
        let timebaseIndex = 7;
        let timebaseDiv = timebaseValues[timebaseIndex];

        // Trigger
        let triggerSource = 'ch1';
        let triggerSlope = 'rising';
        let triggerLevel = 0;

        // Cursors
        let cursorsEnabled = false;
        let cursorMode = 'off';
        let cursor1Pos = 25;
        let cursor2Pos = 75;
        let cursorSource = 'ch1';

        const voltsScales = [0.001, 0.002, 0.005, 0.01, 0.02, 0.05, 0.1, 0.2, 0.5, 1, 2, 5, 10, 20, 50, 100];

        // Update trigger status display
        function updateTriggerStatus() {
            const led = document.getElementById('triggerLed');
            const text = document.getElementById('triggerStatus');
            
            led.className = 'trigger-led';
            
            if (!powerOn) {
                text.textContent = 'OFF';
                return;
            }
            
            switch(triggerMode) {
                case 'auto':
                    led.classList.add('auto');
                    text.textContent = 'AUTO (Free-Run)';
                    break;
                case 'normal':
                    if (waitingForTrigger) {
                        led.classList.add('armed');
                        text.textContent = 'NORMAL (Waiting...)';
                    } else {
                        led.classList.add('normal');
                        text.textContent = 'NORMAL';
                    }
                    break;
                case 'single':
                    if (waitingForTrigger) {
                        led.classList.add('armed');
                        text.textContent = 'SINGLE (Armed)';
                    } else {
                        led.classList.add('normal');
                        text.textContent = 'SINGLE (Stopped)';
                    }
                    break;
            }
        }

        // Show trigger indicator
        function showTriggerIndicator() {
            const indicator = document.getElementById('triggerIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 500);
        }

        // Precision mode control
        document.querySelectorAll('.precision-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                safeExecute(() => {
                    document.querySelectorAll('.precision-btn').forEach(b => {
                        b.classList.remove('active');
                        b.setAttribute('aria-pressed', 'false');
                    });
                    this.classList.add('active');
                    this.setAttribute('aria-pressed', 'true');
                    precisionMode = this.dataset.mode;
                    updateAllInputSteps();
                    updateStepIndicators();
                }, 'Error changing precision mode');
            });
        });

        function updateAllInputSteps() {
            const steps = precisionSteps[precisionMode];
            
            safeExecute(() => {
                document.getElementById('ch1SignalFreq').step = steps.freq;
                document.getElementById('ch2SignalFreq').step = steps.freq;
                document.getElementById('ch1SignalAmp').step = steps.amp;
                document.getElementById('ch2SignalAmp').step = steps.amp;
                document.getElementById('ch1Offset').step = steps.offset;
                document.getElementById('ch2Offset').step = steps.offset;
                document.getElementById('ch1Phase').step = steps.phase;
                document.getElementById('ch2Phase').step = steps.phase;
                document.getElementById('timebaseInput').step = steps.timebase;
                document.getElementById('cursor1Pos').step = steps.cursor;
                document.getElementById('cursor2Pos').step = steps.cursor;
                document.getElementById('ch1VoltsDivInput').step = steps.voltsDiv;
                document.getElementById('ch2VoltsDivInput').step = steps.voltsDiv;
                document.getElementById('triggerLevelInput').step = steps.triggerLevel;
            }, 'Error updating input steps');
        }

        function updateStepIndicators() {
            const steps = precisionSteps[precisionMode];
            
            safeExecute(() => {
                document.getElementById('ch1FreqStep').textContent = `Step: ${steps.freq} Hz`;
                document.getElementById('ch2FreqStep').textContent = `Step: ${steps.freq} Hz`;
                document.getElementById('ch1AmpStep').textContent = `Step: ${steps.amp} V`;
                document.getElementById('ch2AmpStep').textContent = `Step: ${steps.amp} V`;
                document.getElementById('ch1OffsetStep').textContent = `Step: ${steps.offset} V`;
                document.getElementById('ch2OffsetStep').textContent = `Step: ${steps.offset} V`;
                document.getElementById('ch1PhaseStep').textContent = `Step: ${steps.phase} ¬∞`;
                document.getElementById('ch2PhaseStep').textContent = `Step: ${steps.phase} ¬∞`;
                document.getElementById('timebaseStep').textContent = `Step: ${steps.timebase} s`;
                document.getElementById('cursor1Step').textContent = `Step: ${steps.cursor} %`;
                document.getElementById('cursor2Step').textContent = `Step: ${steps.cursor} %`;
                document.getElementById('ch1VoltsDivStep').textContent = `Step: ${steps.voltsDiv} V`;
                document.getElementById('ch2VoltsDivStep').textContent = `Step: ${steps.voltsDiv} V`;
                document.getElementById('triggerLevelStep').textContent = `Step: ${steps.triggerLevel} V`;
            }, 'Error updating step indicators');
        }

        // Adjustment functions with input validation
        function adjustFreq(channel, direction) {
            safeExecute(() => {
                const input = document.getElementById(`${channel}SignalFreq`);
                const step = precisionSteps[precisionMode].freq;
                const newValue = SecurityUtils.sanitizeNumber(
                    parseFloat(input.value) + (direction * step),
                    0.00001,
                    1000000000,
                    channels[channel].frequency
                );
                input.value = newValue;
                channels[channel].frequency = newValue;
            }, 'Error adjusting frequency');
        }

        function adjustAmp(channel, direction) {
            safeExecute(() => {
                const input = document.getElementById(`${channel}SignalAmp`);
                const step = precisionSteps[precisionMode].amp;
                const newValue = SecurityUtils.sanitizeNumber(
                    parseFloat(input.value) + (direction * step),
                    0.000001,
                    1000,
                    channels[channel].amplitude
                );
                input.value = newValue;
                channels[channel].amplitude = newValue;
            }, 'Error adjusting amplitude');
        }

        function adjustOffset(channel, direction) {
            safeExecute(() => {
                const input = document.getElementById(`${channel}Offset`);
                const step = precisionSteps[precisionMode].offset;
                const newValue = SecurityUtils.sanitizeNumber(
                    parseFloat(input.value) + (direction * step),
                    -1000,
                    1000,
                    channels[channel].offset
                );
                input.value = newValue;
                channels[channel].offset = newValue;
            }, 'Error adjusting offset');
        }

        function adjustPhase(channel, direction) {
            safeExecute(() => {
                const input = document.getElementById(`${channel}Phase`);
                const step = precisionSteps[precisionMode].phase;
                let newValue = parseFloat(input.value) + (direction * step);
                newValue = ((newValue % 360) + 360) % 360;
                input.value = newValue;
                channels[channel].phase = newValue;
            }, 'Error adjusting phase');
        }

        function adjustTimebase(direction) {
            safeExecute(() => {
                const input = document.getElementById('timebaseInput');
                const step = precisionSteps[precisionMode].timebase;
                const newValue = SecurityUtils.sanitizeNumber(
                    parseFloat(input.value) + (direction * step),
                    0.000000001,
                    1000,
                    timebaseDiv
                );
                timebaseDiv = newValue;
                input.value = timebaseDiv;
                document.getElementById('timebaseDivDisplay').textContent = formatValue(timebaseDiv, 's');
            }, 'Error adjusting timebase');
        }

        function adjustCursor(cursorNum, direction) {
            safeExecute(() => {
                const input = document.getElementById(`cursor${cursorNum}Pos`);
                const step = precisionSteps[precisionMode].cursor;
                const newValue = SecurityUtils.clamp(
                    parseFloat(input.value) + (direction * step),
                    0,
                    100
                );
                input.value = newValue;
                if (cursorNum === 1) {
                    cursor1Pos = newValue;
                } else {
                    cursor2Pos = newValue;
                }
            }, 'Error adjusting cursor');
        }

        function adjustVoltsDiv(channel, direction) {
            safeExecute(() => {
                const input = document.getElementById(`${channel}VoltsDivInput`);
                const step = precisionSteps[precisionMode].voltsDiv;
                const newValue = SecurityUtils.sanitizeNumber(
                    parseFloat(input.value) + (direction * step),
                    0.000001,
                    1000,
                    channels[channel].voltsDiv
                );
                input.value = newValue;
                channels[channel].voltsDiv = newValue;
                document.getElementById(`${channel}VoltsDivDisplay`).textContent = newValue.toFixed(6) + ' V';
            }, 'Error adjusting volts/div');
        }

        function adjustTriggerLevel(direction) {
            safeExecute(() => {
                const input = document.getElementById('triggerLevelInput');
                const step = precisionSteps[precisionMode].triggerLevel;
                const newValue = SecurityUtils.sanitizeNumber(
                    parseFloat(input.value) + (direction * step),
                    -1000,
                    1000,
                    triggerLevel
                );
                input.value = newValue;
                triggerLevel = newValue;
            }, 'Error adjusting trigger level');
        }

        // Unit selector functions
        function setFreqUnit(channel, multiplier) {
            safeExecute(() => {
                const buttons = event.target.parentElement.querySelectorAll('.unit-btn');
                buttons.forEach(b => {
                    b.classList.remove('active');
                    b.setAttribute('aria-pressed', 'false');
                });
                event.target.classList.add('active');
                event.target.setAttribute('aria-pressed', 'true');
            }, 'Error setting frequency unit');
        }

        function setAmpUnit(channel, multiplier) {
            safeExecute(() => {
                const buttons = event.target.parentElement.querySelectorAll('.unit-btn');
                buttons.forEach(b => {
                    b.classList.remove('active');
                    b.setAttribute('aria-pressed', 'false');
                });
                event.target.classList.add('active');
                event.target.setAttribute('aria-pressed', 'true');
            }, 'Error setting amplitude unit');
        }

        function setTimebaseUnit(multiplier) {
            safeExecute(() => {
                const buttons = event.target.parentElement.querySelectorAll('.unit-btn');
                buttons.forEach(b => {
                    b.classList.remove('active');
                    b.setAttribute('aria-pressed', 'false');
                });
                event.target.classList.add('active');
                event.target.setAttribute('aria-pressed', 'true');
            }, 'Error setting timebase unit');
        }

        // Preset functions with validation
        function setVoltsDiv(channel, value) {
            safeExecute(() => {
                const validatedValue = SecurityUtils.sanitizeNumber(value, 0.000001, 1000, 1);
                channels[channel].voltsDiv = validatedValue;
                document.getElementById(`${channel}VoltsDivDisplay`).textContent = validatedValue.toFixed(6) + ' V';
                document.getElementById(`${channel}VoltsDivInput`).value = validatedValue;
            }, 'Error setting volts/div preset');
        }

        function setTimebase(value) {
            safeExecute(() => {
                const validatedValue = SecurityUtils.sanitizeNumber(value, 0.000000001, 1000, 0.001);
                timebaseDiv = validatedValue;
                document.getElementById('timebaseInput').value = validatedValue;
                document.getElementById('timebaseDivDisplay').textContent = formatValue(validatedValue, 's');
            }, 'Error setting timebase preset');
        }

        // Format value with precision based on mode
        function formatValue(value, unit) {
            if (value === null || value === undefined || isNaN(value) || !isFinite(value)) {
                return `--- ${unit}`;
            }

            const absValue = Math.abs(value);
            let precision;
            
            switch(precisionMode) {
                case 'coarse': precision = 2; break;
                case 'normal': precision = 3; break;
                case 'fine': precision = 6; break;
                case 'ultra': precision = 9; break;
                default: precision = 3;
            }
            
            try {
                if (unit === 'Hz') {
                    if (absValue >= 1e9) return `${(value / 1e9).toFixed(precision)} GHz`;
                    if (absValue >= 1e6) return `${(value / 1e6).toFixed(precision)} MHz`;
                    if (absValue >= 1e3) return `${(value / 1e3).toFixed(precision)} kHz`;
                    return `${value.toFixed(precision)} Hz`;
                }
                
                if (unit === 's') {
                    if (absValue >= 1) return `${value.toFixed(precision)} s`;
                    if (absValue >= 1e-3) return `${(value * 1e3).toFixed(precision)} ms`;
                    if (absValue >= 1e-6) return `${(value * 1e6).toFixed(precision)} Œºs`;
                    if (absValue >= 1e-9) return `${(value * 1e9).toFixed(precision)} ns`;
                    return `${(value * 1e12).toFixed(precision)} ps`;
                }
                
                if (unit === 'V') {
                    if (absValue >= 1e3) return `${(value / 1e3).toFixed(precision)} kV`;
                    if (absValue >= 1) return `${value.toFixed(precision)} V`;
                    if (absValue >= 1e-3) return `${(value * 1e3).toFixed(precision)} mV`;
                    if (absValue >= 1e-6) return `${(value * 1e6).toFixed(precision)} ŒºV`;
                    return `${(value * 1e9).toFixed(precision)} nV`;
                }

                if (unit === '%' || unit === '¬∞' || unit === 'Œºs') {
                    return `${value.toFixed(precision)} ${unit}`;
                }

                if (unit === 'Sa/s') {
                    if (absValue >= 1e9) return `${(value / 1e9).toFixed(2)} GSa/s`;
                    if (absValue >= 1e6) return `${(value / 1e6).toFixed(2)} MSa/s`;
                    if (absValue >= 1e3) return `${(value / 1e3).toFixed(2)} kSa/s`;
                    return `${value.toFixed(2)} Sa/s`;
                }
                
                return `${value.toFixed(precision)} ${unit}`;
            } catch (error) {
                console.error('Error formatting value:', error);
                return `--- ${unit}`;
            }
        }

        // Generate waveform with validation
        function generateWaveform(channel, startTime, numSamples) {
            return safeExecute(() => {
                const data = [];
                const ch = channels[channel];
                const totalTime = timebaseDiv * 10;
                const dt = totalTime / numSamples;
                
                const validatedNumSamples = SecurityUtils.clamp(numSamples, 10, 1000000);
                
                for (let i = 0; i < validatedNumSamples; i++) {
                    const t = startTime + (i * dt);
                    const phase = 2 * Math.PI * ch.frequency * t + (ch.phase * Math.PI / 180);
                    let value = 0;
                    
                    switch (ch.waveform) {
                        case 'sine':
                            value = ch.amplitude * Math.sin(phase);
                            break;
                        case 'square':
                            value = ch.amplitude * (Math.sin(phase) >= 0 ? 1 : -1);
                            break;
                        case 'triangle':
                            const trianglePhase = (phase / (2 * Math.PI)) % 1;
                            value = ch.amplitude * (trianglePhase < 0.5 ? 4 * trianglePhase - 1 : -4 * trianglePhase + 3);
                            break;
                        case 'sawtooth':
                            value = ch.amplitude * (2 * ((phase / (2 * Math.PI)) % 1) - 1);
                            break;
                    }
                    
                    value += ch.offset;
                    
                    // Clamp to reasonable values to prevent overflow
                    value = SecurityUtils.clamp(value, -10000, 10000);
                    data.push(value);
                }
                
                return data;
            }, 'Error generating waveform') || [];
        }

        // Check trigger condition
        function checkTrigger(data) {
            if (!data || data.length < 2) return false;
            
            try {
                for (let i = 1; i < data.length; i++) {
                    const currentValue = data[i];
                    const lastValue = data[i - 1];
                    
                    if (triggerSlope === 'rising') {
                        if (lastValue < triggerLevel && currentValue >= triggerLevel) {
                            return true;
                        }
                    } else {
                        if (lastValue > triggerLevel && currentValue <= triggerLevel) {
                            return true;
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking trigger:', error);
            }
            
            return false;
        }

        // Calculate measurements with error handling
        function calculatePreciseMeasurements(channel, data) {
            if (!channels[channel].enabled || !data || data.length < 2) {
                return null;
            }
            
            return safeExecute(() => {
                const ch = channels[channel];
                let max = -Infinity, min = Infinity, sum = 0, sumSquares = 0;
                
                for (let val of data) {
                    if (!isFinite(val)) continue;
                    if (val > max) max = val;
                    if (val < min) min = val;
                    sum += val;
                    sumSquares += val * val;
                }
                
                const mean = sum / data.length;
                const vpp = max - min;
                const amplitude = vpp / 2;
                const rms = Math.sqrt(sumSquares / data.length);
                const variance = (sumSquares / data.length) - (mean * mean);
                const stdDev = Math.sqrt(Math.max(0, variance));
                
                let zeroCrossings = 0;
                let lastSign = data[0] >= mean ? 1 : -1;
                
                for (let i = 1; i < data.length; i++) {
                    const currentSign = data[i] >= mean ? 1 : -1;
                    if (currentSign !== lastSign && currentSign === 1) {
                        zeroCrossings++;
                    }
                    lastSign = currentSign;
                }
                
                const totalTime = timebaseDiv * 10;
                const measuredFreq = zeroCrossings > 0 ? zeroCrossings / totalTime : ch.frequency;
                const period = measuredFreq > 0 ? 1 / measuredFreq : 0;
                
                const threshold10 = min + (vpp * 0.1);
                const threshold90 = min + (vpp * 0.9);
                let riseTime = 0, fallTime = 0, risingEdges = 0, fallingEdges = 0;
                
                for (let i = 1; i < data.length; i++) {
                    if (data[i-1] < threshold10 && data[i] >= threshold90) {
                        let startIdx = i - 1;
                        while (startIdx > 0 && data[startIdx] > threshold10) startIdx--;
                        riseTime += (i - startIdx) * (totalTime / data.length);
                        risingEdges++;
                    } else if (data[i-1] > threshold90 && data[i] <= threshold10) {
                        let startIdx = i - 1;
                        while (startIdx > 0 && data[startIdx] < threshold90) startIdx--;
                        fallTime += (i - startIdx) * (totalTime / data.length);
                        fallingEdges++;
                    }
                }
                
                riseTime = risingEdges > 0 ? (riseTime / risingEdges) * 1e6 : 0;
                fallTime = fallingEdges > 0 ? (fallTime / fallingEdges) * 1e6 : 0;
                
                let highTime = 0;
                for (let i = 0; i < data.length; i++) {
                    if (data[i] >= mean) highTime++;
                }
                const dutyCycle = (highTime / data.length) * 100;
                
                const steadyState = max * 0.9;
                const overshoot = max > steadyState ? ((max - steadyState) / steadyState) * 100 : 0;
                const cycles = Math.floor(zeroCrossings / 2);
                
                return {
                    freq: measuredFreq,
                    period: period,
                    vpp: vpp,
                    amp: amplitude,
                    rms: rms,
                    mean: mean,
                    max: max,
                    min: min,
                    riseTime: riseTime,
                    fallTime: fallTime,
                    dutyCycle: dutyCycle,
                    overshoot: overshoot,
                    stdDev: stdDev,
                    cycles: cycles
                };
            }, 'Error calculating measurements');
        }

        // Draw functions with performance optimizations
        function drawGrid() {
            safeExecute(() => {
                const width = canvas.width;
                const height = canvas.height;
                const divX = width / 10;
                const divY = height / 8;
                
                ctx.fillStyle = '#001a1a';
                ctx.fillRect(0, 0, width, height);
                
                ctx.strokeStyle = '#003333';
                ctx.lineWidth = 1;
                
                ctx.beginPath();
                for (let i = 0; i <= 10; i++) {
                    ctx.moveTo(i * divX, 0);
                    ctx.lineTo(i * divX, height);
                }
                for (let i = 0; i <= 8; i++) {
                    ctx.moveTo(0, i * divY);
                    ctx.lineTo(width, i * divY);
                }
                ctx.stroke();
                
                ctx.strokeStyle = '#005555';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(width / 2, 0);
                ctx.lineTo(width / 2, height);
                ctx.moveTo(0, height / 2);
                ctx.lineTo(width, height / 2);
                ctx.stroke();
                
                ctx.fillStyle = '#004444';
                const dotSpacingX = divX / 5;
                const dotSpacingY = divY / 5;
                
                for (let x = 0; x <= width; x += dotSpacingX) {
                    for (let y = 0; y <= height; y += dotSpacingY) {
                        ctx.fillRect(x - 0.5, y - 0.5, 1, 1);
                    }
                }
            }, 'Error drawing grid');
        }

        function drawWaveform(channel, data) {
            if (!channels[channel].enabled || !data || data.length === 0) return;
            
            safeExecute(() => {
                const width = canvas.width;
                const height = canvas.height;
                const ch = channels[channel];
                const centerY = height / 2;
                const pixelsPerDiv = height / 8;
                
                ctx.strokeStyle = ch.color;
                ctx.lineWidth = 2;
                ctx.shadowBlur = 5;
                ctx.shadowColor = ch.color;
                ctx.beginPath();
                
                for (let i = 0; i < data.length; i++) {
                    const x = (i / data.length) * width;
                    const voltsToPixels = pixelsPerDiv / ch.voltsDiv;
                    const y = centerY - (data[i] * voltsToPixels) + (ch.position * pixelsPerDiv / 100);
                    
                    // Clamp y to canvas bounds
                    const clampedY = SecurityUtils.clamp(y, -height, height * 2);
                    
                    if (i === 0) {
                        ctx.moveTo(x, clampedY);
                    } else {
                        ctx.lineTo(x, clampedY);
                    }
                }
                
                ctx.stroke();
                ctx.shadowBlur = 0;
            }, 'Error drawing waveform');
        }

        function drawTriggerLevel() {
            safeExecute(() => {
                const height = canvas.height;
                const centerY = height / 2;
                const pixelsPerDiv = height / 8;
                const ch = channels[triggerSource];
                const voltsToPixels = pixelsPerDiv / ch.voltsDiv;
                const y = centerY - (triggerLevel * voltsToPixels);
                
                let triggerColor = '#ff00ff';
                if (waitingForTrigger) triggerColor = '#ff9800';
                
                ctx.strokeStyle = triggerColor;
                ctx.lineWidth = 2;
                ctx.setLineDash([10, 5]);
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
                ctx.setLineDash([]);
                
                ctx.fillStyle = triggerColor;
                ctx.beginPath();
                if (triggerSlope === 'rising') {
                    ctx.moveTo(10, y);
                    ctx.lineTo(20, y - 8);
                    ctx.lineTo(20, y + 8);
                } else {
                    ctx.moveTo(10, y);
                    ctx.lineTo(20, y + 8);
                    ctx.lineTo(20, y - 8);
                }
                ctx.closePath();
                ctx.fill();
            }, 'Error drawing trigger level');
        }

        function drawCursors(ch1Data, ch2Data) {
            if (cursorMode === 'off' || !cursorsEnabled) return;
            
            safeExecute(() => {
                const width = canvas.width;
                const height = canvas.height;
                
                ctx.setLineDash([5, 5]);
                ctx.lineWidth = 1;
                
                if (cursorMode === 'vertical' || cursorMode === 'both') {
                    const x1 = (cursor1Pos / 100) * width;
                    ctx.strokeStyle = '#ff00ff';
                    ctx.beginPath();
                    ctx.moveTo(x1, 0);
                    ctx.lineTo(x1, height);
                    ctx.stroke();
                    
                    const x2 = (cursor2Pos / 100) * width;
                    ctx.strokeStyle = '#ff66ff';
                    ctx.beginPath();
                    ctx.moveTo(x2, 0);
                    ctx.lineTo(x2, height);
                    ctx.stroke();
                    
                    const totalTime = timebaseDiv * 10;
                    const t1 = (cursor1Pos / 100) * totalTime;
                    const t2 = (cursor2Pos / 100) * totalTime;
                    const dt = Math.abs(t2 - t1);
                    const freq = dt > 0 ? 1 / dt : 0;
                    
                    document.getElementById('cursor1Time').textContent = formatValue(t1, 's');
                    document.getElementById('cursor2Time').textContent = formatValue(t2, 's');
                    document.getElementById('deltaTime').textContent = formatValue(dt, 's');
                    document.getElementById('deltaFreq').textContent = formatValue(freq, 'Hz');
                    
                    const data = cursorSource === 'ch1' ? ch1Data : ch2Data;
                    if (data && data.length > 0) {
                        const idx1 = Math.floor((cursor1Pos / 100) * data.length);
                        const idx2 = Math.floor((cursor2Pos / 100) * data.length);
                        const v1 = data[Math.min(idx1, data.length - 1)];
                        const v2 = data[Math.min(idx2, data.length - 1)];
                        const dv = Math.abs(v2 - v1);
                        
                        document.getElementById('cursor1Volt').textContent = formatValue(v1, 'V');
                        document.getElementById('cursor2Volt').textContent = formatValue(v2, 'V');
                        document.getElementById('deltaVolt').textContent = formatValue(dv, 'V');
                    }
                }
                
                ctx.setLineDash([]);
            }, 'Error drawing cursors');
        }

        function updateMeasurements(ch1Data, ch2Data) {
            safeExecute(() => {
                const ch1Meas = calculatePreciseMeasurements('ch1', ch1Data);
                const ch2Meas = calculatePreciseMeasurements('ch2', ch2Data);
                
                if (ch1Meas) {
                    document.getElementById('ch1Freq').textContent = formatValue(ch1Meas.freq, 'Hz');
                    document.getElementById('ch1Period').textContent = formatValue(ch1Meas.period, 's');
                    document.getElementById('ch1Vpp').textContent = formatValue(ch1Meas.vpp, 'V');
                    document.getElementById('ch1Amp').textContent = formatValue(ch1Meas.amp, 'V');
                    document.getElementById('ch1Rms').textContent = formatValue(ch1Meas.rms, 'V');
                    document.getElementById('ch1Mean').textContent = formatValue(ch1Meas.mean, 'V');
                    document.getElementById('ch1Max').textContent = formatValue(ch1Meas.max, 'V');
                    document.getElementById('ch1Min').textContent = formatValue(ch1Meas.min, 'V');
                    document.getElementById('ch1Rise').textContent = formatValue(ch1Meas.riseTime, 'Œºs');
                    document.getElementById('ch1Fall').textContent = formatValue(ch1Meas.fallTime, 'Œºs');
                    document.getElementById('ch1Duty').textContent = formatValue(ch1Meas.dutyCycle, '%');
                    document.getElementById('ch1Over').textContent = formatValue(ch1Meas.overshoot, '%');
                    document.getElementById('ch1StdDev').textContent = formatValue(ch1Meas.stdDev, 'V');
                    document.getElementById('ch1Cycles').textContent = ch1Meas.cycles;
                }
                
                if (ch2Meas) {
                    document.getElementById('ch2Freq').textContent = formatValue(ch2Meas.freq, 'Hz');
                    document.getElementById('ch2Period').textContent = formatValue(ch2Meas.period, 's');
                    document.getElementById('ch2Vpp').textContent = formatValue(ch2Meas.vpp, 'V');
                    document.getElementById('ch2Amp').textContent = formatValue(ch2Meas.amp, 'V');
                    document.getElementById('ch2Rms').textContent = formatValue(ch2Meas.rms, 'V');
                    document.getElementById('ch2Mean').textContent = formatValue(ch2Meas.mean, 'V');
                    document.getElementById('ch2Max').textContent = formatValue(ch2Meas.max, 'V');
                    document.getElementById('ch2Min').textContent = formatValue(ch2Meas.min, 'V');
                    document.getElementById('ch2Rise').textContent = formatValue(ch2Meas.riseTime, 'Œºs');
                    document.getElementById('ch2Fall').textContent = formatValue(ch2Meas.fallTime, 'Œºs');
                    document.getElementById('ch2Duty').textContent = formatValue(ch2Meas.dutyCycle, '%');
                    document.getElementById('ch2Over').textContent = formatValue(ch2Meas.overshoot, '%');
                    document.getElementById('ch2StdDev').textContent = formatValue(ch2Meas.stdDev, 'V');
                    document.getElementById('ch2Cycles').textContent = ch2Meas.cycles;
                }
                
                if (ch1Meas && ch2Meas) {
                    const phase1 = channels.ch1.phase;
                    const phase2 = channels.ch2.phase;
                    const phaseDiff = ((phase2 - phase1 + 360) % 360);
                    const timeDelay = (phaseDiff / 360) * ch2Meas.period;
                    
                    document.getElementById('phaseDiff').textContent = formatValue(phaseDiff, '¬∞');
                    document.getElementById('timeDelay').textContent = formatValue(timeDelay, 's');
                }
                
                const numSamples = ch1Data ? ch1Data.length : 0;
                document.getElementById('sampleRate').textContent = formatValue(sampleRate, 'Sa/s');
                document.getElementById('numSamples').textContent = numSamples;
                document.getElementById('cursorMode').textContent = cursorMode.toUpperCase();
            }, 'Error updating measurements');
        }

        function draw() {
            if (!powerOn) return;
            
            safeExecute(() => {
                drawGrid();
                
                const numSamples = Math.floor((timebaseDiv * 10) * sampleRate);
                const clampedSamples = SecurityUtils.clamp(numSamples, 10, 100000);
                let ch1Data, ch2Data;
                
                // Handle different trigger modes
                if (triggerMode === 'auto') {
                    ch1Data = generateWaveform('ch1', time, clampedSamples);
                    ch2Data = generateWaveform('ch2', time, clampedSamples);
                    
                    const triggerData = triggerSource === 'ch1' ? ch1Data : ch2Data;
                    if (checkTrigger(triggerData)) {
                        showTriggerIndicator();
                    }
                    
                    time += 0.0001;
                } else if (triggerMode === 'normal') {
                    ch1Data = generateWaveform('ch1', time, clampedSamples);
                    ch2Data = generateWaveform('ch2', time, clampedSamples);
                    
                    const triggerData = triggerSource === 'ch1' ? ch1Data : ch2Data;
                    
                    if (waitingForTrigger) {
                        if (checkTrigger(triggerData)) {
                            waitingForTrigger = false;
                            showTriggerIndicator();
                            updateTriggerStatus();
                            capturedData = { ch1: ch1Data, ch2: ch2Data };
                        } else {
                            ctx.fillStyle = '#ff9800';
                            ctx.font = 'bold 16px monospace';
                            ctx.fillText('‚ö† NORMAL MODE - WAITING FOR TRIGGER...', canvas.width / 2 - 200, 50);
                        }
                    } else {
                        if (checkTrigger(triggerData)) {
                            showTriggerIndicator();
                        }
                    }
                    
                    time += 0.0001;
                } else if (triggerMode === 'single') {
                    if (waitingForTrigger) {
                        ch1Data = generateWaveform('ch1', time, clampedSamples);
                        ch2Data = generateWaveform('ch2', time, clampedSamples);
                        
                        const triggerData = triggerSource === 'ch1' ? ch1Data : ch2Data;
                        
                        if (checkTrigger(triggerData)) {
                            capturedData = { ch1: ch1Data, ch2: ch2Data };
                            waitingForTrigger = false;
                            running = false;
                            showTriggerIndicator();
                            updateTriggerStatus();
                            document.getElementById('runBtn').disabled = false;
                            document.getElementById('stopBtn').disabled = true;
                            document.getElementById('singleBtn').classList.remove('armed');
                        } else {
                            ctx.fillStyle = '#ff9800';
                            ctx.font = 'bold 16px monospace';
                            ctx.fillText('‚ö° SINGLE MODE - WAITING FOR TRIGGER...', canvas.width / 2 - 200, 50);
                        }
                        
                        time += 0.0001;
                    } else if (capturedData) {
                        ch1Data = capturedData.ch1;
                        ch2Data = capturedData.ch2;
                    } else {
                        ch1Data = channels.ch1.data;
                        ch2Data = channels.ch2.data;
                    }
                }
                
                channels.ch1.data = ch1Data;
                channels.ch2.data = ch2Data;
                
                drawWaveform('ch1', ch1Data);
                drawWaveform('ch2', ch2Data);
                drawTriggerLevel();
                drawCursors(ch1Data, ch2Data);
                
                ctx.fillStyle = '#00ff66';
                ctx.font = 'bold 14px monospace';
                ctx.shadowBlur = 0;
                ctx.fillText(`CH1: ${channels.ch1.voltsDiv.toFixed(6)}V/div | CH2: ${channels.ch2.voltsDiv.toFixed(6)}V/div | TIME: ${formatValue(timebaseDiv, 's')}/div | MODE: ${triggerMode.toUpperCase()}/${precisionMode.toUpperCase()}`, 10, 25);
                
                updateMeasurements(ch1Data, ch2Data);
                
                if (running) {
                    animationId = requestAnimationFrame(draw);
                }
            }, 'Error in draw function');
        }

        // Power controls with validation
        function togglePower() {
            safeExecute(() => {
                powerOn = !powerOn;
                
                if (powerOn) {
                    document.getElementById('powerLed').classList.add('on');
                    document.getElementById('powerBtn').textContent = '‚ö° POWER OFF';
                    document.getElementById('powerBtn').setAttribute('aria-label', 'Power off');
                    document.getElementById('runBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('singleBtn').disabled = false;
                    startRunning();
                } else {
                    document.getElementById('powerLed').classList.remove('on');
                    document.getElementById('powerBtn').textContent = '‚ö° POWER ON';
                    document.getElementById('powerBtn').setAttribute('aria-label', 'Power on');
                    document.getElementById('runBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = true;
                    document.getElementById('singleBtn').disabled = true;
                    stopRunning();
                    waitingForTrigger = false;
                    updateTriggerStatus();
                    ctx.fillStyle = '#001a1a';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
            }, 'Error toggling power');
        }

        function startRunning() {
            safeExecute(() => {
                running = true;
                waitingForTrigger = (triggerMode === 'normal');
                updateTriggerStatus();
                document.getElementById('runBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('singleBtn').classList.remove('armed');
                draw();
            }, 'Error starting');
        }

        function stopRunning() {
            safeExecute(() => {
                running = false;
                waitingForTrigger = false;
                updateTriggerStatus();
                document.getElementById('runBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                draw();
            }, 'Error stopping');
        }

        function singleShot() {
            if (!powerOn) return;
            
            safeExecute(() => {
                running = true;
                waitingForTrigger = true;
                updateTriggerStatus();
                
                document.getElementById('runBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('singleBtn').classList.add('armed');
                
                draw();
            }, 'Error in single shot');
        }

        // Event listeners with error handling
        document.getElementById('powerBtn').addEventListener('click', togglePower);
        document.getElementById('runBtn').addEventListener('click', startRunning);
        document.getElementById('stopBtn').addEventListener('click', stopRunning);
        document.getElementById('singleBtn').addEventListener('click', singleShot);

        // Trigger mode selector
        document.getElementById('triggerModeSelect').addEventListener('change', function() {
            safeExecute(() => {
                triggerMode = this.value;
                
                if (running) {
                    if (triggerMode === 'normal') {
                        waitingForTrigger = true;
                    } else if (triggerMode === 'auto') {
                        waitingForTrigger = false;
                    }
                }
                
                updateTriggerStatus();
            }, 'Error changing trigger mode');
        });

        // Channel 1 controls
        document.getElementById('ch1Toggle').addEventListener('click', function() {
            safeExecute(() => {
                channels.ch1.enabled = !channels.ch1.enabled;
                this.classList.toggle('active');
                this.setAttribute('aria-checked', channels.ch1.enabled.toString());
            }, 'Error toggling CH1');
        });

        document.getElementById('ch1VoltsDiv').addEventListener('input', function() {
            safeExecute(() => {
                const value = voltsScales[parseInt(this.value)];
                channels.ch1.voltsDiv = value;
                document.getElementById('ch1VoltsDivDisplay').textContent = value.toFixed(6) + ' V';
                document.getElementById('ch1VoltsDivInput').value = value;
            }, 'Error adjusting CH1 volts/div');
        });

        document.getElementById('ch1VoltsDivInput').addEventListener('input', function() {
            safeExecute(() => {
                const value = SecurityUtils.sanitizeNumber(parseFloat(this.value), 0.000001, 1000, 1);
                if (value > 0) {
                    channels.ch1.voltsDiv = value;
                    document.getElementById('ch1VoltsDivDisplay').textContent = value.toFixed(6) + ' V';
                }
            }, 'Error setting CH1 volts/div');
        });

        document.getElementById('ch1Position').addEventListener('input', function() {
            safeExecute(() => {
                channels.ch1.position = SecurityUtils.sanitizeNumber(parseInt(this.value), -100, 100, 0);
                document.getElementById('ch1PosDisplay').textContent = channels.ch1.position;
            }, 'Error adjusting CH1 position');
        });

        document.getElementById('ch1SignalFreq').addEventListener('input', function() {
            safeExecute(() => {
                channels.ch1.frequency = SecurityUtils.sanitizeNumber(parseFloat(this.value), 0.00001, 1000000000, 1000);
            }, 'Error setting CH1 frequency');
        });

        document.getElementById('ch1SignalAmp').addEventListener('input', function() {
            safeExecute(() => {
                channels.ch1.amplitude = SecurityUtils.sanitizeNumber(parseFloat(this.value), 0.000001, 1000, 2);
            }, 'Error setting CH1 amplitude');
        });

        document.getElementById('ch1Offset').addEventListener('input', function() {
            safeExecute(() => {
                channels.ch1.offset = SecurityUtils.sanitizeNumber(parseFloat(this.value), -1000, 1000, 0);
            }, 'Error setting CH1 offset');
        });

        document.getElementById('ch1Phase').addEventListener('input', function() {
            safeExecute(() => {
                channels.ch1.phase = SecurityUtils.sanitizeNumber(parseFloat(this.value), 0, 360, 0);
            }, 'Error setting CH1 phase');
        });

        // Channel 2 controls
        document.getElementById('ch2Toggle').addEventListener('click', function() {
            safeExecute(() => {
                channels.ch2.enabled = !channels.ch2.enabled;
                this.classList.toggle('active');
                this.setAttribute('aria-checked', channels.ch2.enabled.toString());
            }, 'Error toggling CH2');
        });

        document.getElementById('ch2VoltsDiv').addEventListener('input', function() {
            safeExecute(() => {
                const value = voltsScales[parseInt(this.value)];
                channels.ch2.voltsDiv = value;
                document.getElementById('ch2VoltsDivDisplay').textContent = value.toFixed(6) + ' V';
                document.getElementById('ch2VoltsDivInput').value = value;
            }, 'Error adjusting CH2 volts/div');
        });

        document.getElementById('ch2VoltsDivInput').addEventListener('input', function() {
            safeExecute(() => {
                const value = SecurityUtils.sanitizeNumber(parseFloat(this.value), 0.000001, 1000, 1);
                if (value > 0) {
                    channels.ch2.voltsDiv = value;
                    document.getElementById('ch2VoltsDivDisplay').textContent = value.toFixed(6) + ' V';
                }
            }, 'Error setting CH2 volts/div');
        });

        document.getElementById('ch2Position').addEventListener('input', function() {
            safeExecute(() => {
                channels.ch2.position = SecurityUtils.sanitizeNumber(parseInt(this.value), -100, 100, 0);
                document.getElementById('ch2PosDisplay').textContent = channels.ch2.position;
            }, 'Error adjusting CH2 position');
        });

        document.getElementById('ch2SignalFreq').addEventListener('input', function() {
            safeExecute(() => {
                channels.ch2.frequency = SecurityUtils.sanitizeNumber(parseFloat(this.value), 0.00001, 1000000000, 500);
            }, 'Error setting CH2 frequency');
        });

        document.getElementById('ch2SignalAmp').addEventListener('input', function() {
            safeExecute(() => {
                channels.ch2.amplitude = SecurityUtils.sanitizeNumber(parseFloat(this.value), 0.000001, 1000, 3);
            }, 'Error setting CH2 amplitude');
        });

        document.getElementById('ch2Offset').addEventListener('input', function() {
            safeExecute(() => {
                channels.ch2.offset = SecurityUtils.sanitizeNumber(parseFloat(this.value), -1000, 1000, 0);
            }, 'Error setting CH2 offset');
        });

        document.getElementById('ch2Phase').addEventListener('input', function() {
            safeExecute(() => {
                channels.ch2.phase = SecurityUtils.sanitizeNumber(parseFloat(this.value), 0, 360, 0);
            }, 'Error setting CH2 phase');
        });

        // Waveform buttons
        document.querySelectorAll('.wave-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                safeExecute(() => {
                    const ch = this.dataset.ch;
                    const wave = this.dataset.wave;
                    const channel = ch === '1' ? 'ch1' : 'ch2';
                    
                    this.parentElement.querySelectorAll('.wave-btn').forEach(b => {
                        b.classList.remove('active');
                        b.setAttribute('aria-pressed', 'false');
                    });
                    this.classList.add('active');
                    this.setAttribute('aria-pressed', 'true');
                    
                    channels[channel].waveform = wave;
                }, 'Error setting waveform');
            });
        });

        // Timebase controls
        document.getElementById('timebaseDiv').addEventListener('input', function() {
            safeExecute(() => {
                timebaseIndex = parseInt(this.value);
                timebaseDiv = timebaseValues[timebaseIndex];
                document.getElementById('timebaseDivDisplay').textContent = formatValue(timebaseDiv, 's');
                document.getElementById('timebaseInput').value = timebaseDiv;
            }, 'Error adjusting timebase');
        });

        document.getElementById('timebaseInput').addEventListener('input', function() {
            safeExecute(() => {
                timebaseDiv = SecurityUtils.sanitizeNumber(parseFloat(this.value), 0.000000001, 1000, 0.0002);
                document.getElementById('timebaseDivDisplay').textContent = formatValue(timebaseDiv, 's');
            }, 'Error setting timebase');
        });

        document.getElementById('sampleRateSelect').addEventListener('change', function() {
            safeExecute(() => {
                sampleRate = SecurityUtils.sanitizeNumber(parseInt(this.value), 1000, 100000000, 10000);
            }, 'Error setting sample rate');
        });

        // Trigger controls
        document.getElementById('triggerSource').addEventListener('change', function() {
            safeExecute(() => {
                triggerSource = this.value;
            }, 'Error setting trigger source');
        });

        document.getElementById('triggerSlope').addEventListener('change', function() {
            safeExecute(() => {
                triggerSlope = this.value;
            }, 'Error setting trigger slope');
        });

        document.getElementById('triggerLevelInput').addEventListener('input', function() {
            safeExecute(() => {
                triggerLevel = SecurityUtils.sanitizeNumber(parseFloat(this.value), -1000, 1000, 0);
            }, 'Error setting trigger level');
        });

        // Cursor controls
        document.getElementById('cursorsToggle').addEventListener('click', function() {
            safeExecute(() => {
                cursorsEnabled = !cursorsEnabled;
                this.classList.toggle('active');
                this.setAttribute('aria-checked', cursorsEnabled.toString());
                if (!cursorsEnabled) {
                    cursorMode = 'off';
                    document.getElementById('cursorModeSelect').value = 'off';
                }
            }, 'Error toggling cursors');
        });

        document.getElementById('cursorModeSelect').addEventListener('change', function() {
            safeExecute(() => {
                cursorMode = this.value;
                if (cursorMode !== 'off') {
                    cursorsEnabled = true;
                    document.getElementById('cursorsToggle').classList.add('active');
                    document.getElementById('cursorsToggle').setAttribute('aria-checked', 'true');
                } else {
                    cursorsEnabled = false;
                    document.getElementById('cursorsToggle').classList.remove('active');
                    document.getElementById('cursorsToggle').setAttribute('aria-checked', 'false');
                }
            }, 'Error setting cursor mode');
        });

        document.getElementById('cursor1Pos').addEventListener('input', function() {
            safeExecute(() => {
                cursor1Pos = SecurityUtils.sanitizeNumber(parseFloat(this.value), 0, 100, 25);
            }, 'Error adjusting cursor 1');
        });

        document.getElementById('cursor2Pos').addEventListener('input', function() {
            safeExecute(() => {
                cursor2Pos = SecurityUtils.sanitizeNumber(parseFloat(this.value), 0, 100, 75);
            }, 'Error adjusting cursor 2');
        });

        document.getElementById('cursorSource').addEventListener('change', function() {
            safeExecute(() => {
                cursorSource = this.value;
            }, 'Error setting cursor source');
        });

        // Keyboard shortcuts with validation
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            
            safeExecute(() => {
                switch(e.key.toLowerCase()) {
                    case 'p':
                        e.preventDefault();
                        togglePower();
                        break;
                    case ' ':
                        e.preventDefault();
                        if (powerOn) {
                            running ? stopRunning() : startRunning();
                        }
                        break;
                    case 's':
                        e.preventDefault();
                        singleShot();
                        break;
                    case '1':
                        e.preventDefault();
                        document.getElementById('ch1Toggle').click();
                        break;
                    case '2':
                        e.preventDefault();
                        document.getElementById('ch2Toggle').click();
                        break;
                    case 'c':
                        e.preventDefault();
                        document.getElementById('cursorsToggle').click();
                        break;
                    case 'f1':
                        e.preventDefault();
                        document.querySelector('[data-mode="coarse"]').click();
                        break;
                    case 'f2':
                        e.preventDefault();
                        document.querySelector('[data-mode="normal"]').click();
                        break;
                    case 'f3':
                        e.preventDefault();
                        document.querySelector('[data-mode="fine"]').click();
                        break;
                    case 'f4':
                        e.preventDefault();
                        document.querySelector('[data-mode="ultra"]').click();
                        break;
                    case 'arrowright':
                        e.preventDefault();
                        adjustTimebase(1);
                        break;
                    case 'arrowleft':
                        e.preventDefault();
                        adjustTimebase(-1);
                        break;
                    case 'arrowup':
                        e.preventDefault();
                        const ch1Slider = document.getElementById('ch1VoltsDiv');
                        if (parseInt(ch1Slider.value) < voltsScales.length - 1) {
                            ch1Slider.value = parseInt(ch1Slider.value) + 1;
                            ch1Slider.dispatchEvent(new Event('input'));
                        }
                        break;
                    case 'arrowdown':
                        e.preventDefault();
                        const ch1Slider2 = document.getElementById('ch1VoltsDiv');
                        if (parseInt(ch1Slider2.value) > 0) {
                            ch1Slider2.value = parseInt(ch1Slider2.value) - 1;
                            ch1Slider2.dispatchEvent(new Event('input'));
                        }
                        break;
                }
            }, 'Error handling keyboard shortcut');
        });

        // Cookie consent logic with localStorage security
        window.addEventListener('load', function() {
            safeExecute(() => {
                try {
                    if (!localStorage.getItem('cookieConsent')) {
                        document.getElementById('cookieConsent').style.display = 'block';
                    }
                } catch (error) {
                    console.warn('localStorage not available:', error);
                }
            }, 'Error loading cookie consent');
        });

        function acceptCookies() {
            safeExecute(() => {
                try {
                    localStorage.setItem('cookieConsent', 'accepted');
                    localStorage.setItem('cookieConsentDate', new Date().toISOString());
                    document.getElementById('cookieConsent').style.display = 'none';
                } catch (error) {
                    console.warn('Could not save cookie consent:', error);
                    document.getElementById('cookieConsent').style.display = 'none';
                }
            }, 'Error accepting cookies');
        }

        function rejectCookies() {
            safeExecute(() => {
                try {
                    localStorage.setItem('cookieConsent', 'rejected');
                    localStorage.setItem('cookieConsentDate', new Date().toISOString());
                    document.getElementById('cookieConsent').style.display = 'none';
                    alert('‚ö† Non-essential cookies rejected. Note: This may limit ad personalization, but ads will still be displayed.');
                } catch (error) {
                    console.warn('Could not save cookie consent:', error);
                    document.getElementById('cookieConsent').style.display = 'none';
                }
            }, 'Error rejecting cookies');
        }

        // Initialize application
        safeExecute(() => {
            updateAllInputSteps();
            updateStepIndicators();
            updateTriggerStatus();
            drawGrid();
        }, 'Error initializing application');

        // Performance monitoring (development only - remove in production)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('Development mode - Performance monitoring enabled');
            let frameCount = 0;
            let lastTime = performance.now();
            
            setInterval(() => {
                const currentTime = performance.now();
                const fps = (frameCount * 1000) / (currentTime - lastTime);
                if (running) {
                    console.log(`FPS: ${fps.toFixed(2)}`);
                }
                frameCount = 0;
                lastTime = currentTime;
            }, 1000);
            
            const originalDraw = draw;
            draw = function() {
                frameCount++;
                originalDraw();
            };
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        });
    </script>
</body>
</html>